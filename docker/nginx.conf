# Use a non-privileged user for security
user                            nginx;
worker_processes                auto;

# Log to stdout/stderr for Docker logging
error_log                       /dev/stderr warn;
pid                             /var/run/nginx.pid;

events {
    worker_connections          1024;
}

http {
    # Basic Settings
    include                     /etc/nginx/mime.types;
    default_type                application/octet-stream;
    sendfile                    on;
    tcp_nopush                  on;
    tcp_nodelay                 on;
    keepalive_timeout           65;
    types_hash_max_size         2048;

    # Gzip Compression for text-based assets
    gzip                        on;
    gzip_vary                   on;
    gzip_proxied                any;
    gzip_comp_level             6;
    # Note: We are not gzipping .png tiles as they are already compressed.
    gzip_types                  text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss image/svg+xml;

    # Main Server Block
    server {
        listen                  80;
        server_name             _; # Listens to any server name
        
        # Root directory for all content
        root                    /usr/share/nginx/html;
        index                   index.html;

        # Location for the Vite React App
        # Handles client-side routing by redirecting all non-file requests to index.html
        location / {
            try_files           $uri $uri/ /index.html;
        }

        # Optimized location for serving map tiles (*.png)
        # All files under /usr/share/nginx/html/tiles/ will be matched here
        location /tiles/ {
            # Aggressively cache tiles in the browser and on any intermediary proxies.
            expires             30d;
            add_header          Cache-Control "public";

            # Turn off logging for tile requests to reduce I/O overhead.
            access_log          off;

            # Nginx File Cache Optimization for frequently accessed tiles
            # This keeps file handles open for popular tiles, reducing disk I/O. [2]
            open_file_cache     max=2000 inactive=30s;
            open_file_cache_valid 60s;
            open_file_cache_min_uses 2;
            open_file_cache_errors on;
        }

        # Redirect server error pages to the static page /50x.html
        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root                /usr/share/nginx/html;
        }
    }
}